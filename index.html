<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextStepMotion (‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π WMFT)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MediaPipe Libraries (Use Latest Stable) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #111827;
            overscroll-behavior-y: none;
            height: 100dvh;
            color: white;
            overflow: hidden;
        }
        
        #dashboard-screen {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 5rem; /* Ensure space at bottom */
        }

        #video-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #output-canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }

        #grid-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            z-index: 10;
            pointer-events: none;
            opacity: 0; 
            transition: opacity 0.3s ease;
        }

        #grid-overlay.visible {
            opacity: 1;
        }

        .grid-cell {
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.3);
            position: relative;
            transition: all 0.2s ease;
        }

        .grid-cell::after {
            content: attr(data-label);
            position: absolute;
        }

        .grid-cell.target {
            background-color: rgba(239, 68, 68, 0.15);
            border: 3px solid #ef4444;
            color: white;
            animation: pulse-target 1.5s infinite;
        }

        .grid-cell.near {
            border: 3px dashed #fbbf24 !important;
            background-color: rgba(234, 179, 8, 0.25) !important;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
        }

        .grid-cell.hovering {
            background-color: rgba(234, 179, 8, 0.6) !important;
            border: 3px solid #fbbf24 !important;
            transform: scale(0.98);
        }

        .grid-cell.success {
            background-color: rgba(34, 197, 94, 0.8) !important;
            border-color: #22c55e !important;
            transform: scale(1.05);
            z-index: 20;
        }

        @keyframes pulse-target {
            0% { box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.2); }
            50% { box-shadow: inset 0 0 30px rgba(239, 68, 68, 0.6); }
            100% { box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.2); }
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        #input-video { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .bar-fill { transition: height 1s ease-out; }
        .bar-active { border: 2px solid white; opacity: 1 !important; transform: scale(1.1); }
        
        /* Toggle Switch CSS Fixed */
        .toggle-checkbox:checked + .toggle-track {
            background-color: #10B981; 
        }
        .toggle-checkbox:checked ~ .toggle-dot {
            transform: translateX(100%);
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Custom Scrollbar for Modal */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #374151; 
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #6B7280; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex flex-col h-full w-full">

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen" class="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-8 bg-gray-900 w-full h-full overflow-y-auto">
        <div class="mb-4 text-green-500">
            <i class="fas fa-universal-access text-7xl animate-pulse"></i>
        </div>
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">NextStepMotion</h1>
            <p class="text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π (WMFT + ROM)</p>
        </div>
        <button id="btn-demo-start" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-10 rounded-full shadow-lg flex items-center gap-3 transition transform hover:scale-105 text-xl">
            <i class="fas fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </button>
    </div>

    <!-- 2. DASHBOARD -->
    <div id="dashboard-screen" class="hidden flex-1 flex flex-col bg-gray-900 w-full h-full overflow-y-auto">
        <header class="bg-gray-800 p-4 shadow-md flex justify-between items-center border-b border-gray-700 sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center font-bold text-white">U</div>
                <div>
                    <h2 class="font-bold text-white text-sm">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</h2>
                    <p class="text-xs text-gray-400">Wolf Motor Function Test</p>
                </div>
            </div>
            <div class="flex gap-3">
                <!-- Info Button -->
                <button id="btn-info" class="text-gray-400 hover:text-white p-2 relative z-20">
                    <i class="fas fa-question-circle text-xl"></i>
                </button>
                <button id="btn-settings" class="text-gray-400 hover:text-white p-2 relative z-20">
                    <i class="fas fa-cog text-xl"></i>
                </button>
                <button id="btn-logout" class="text-gray-400 hover:text-white p-2">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </header>

        <div class="p-6 flex-1 flex flex-col space-y-6">
            <div class="bg-gradient-to-r from-green-800 to-emerald-900 p-6 rounded-2xl shadow-lg border border-green-700 text-center">
                <h3 class="text-xl font-bold text-white mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <p class="text-green-200 text-sm mb-4">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß + ‡∏ß‡∏±‡∏î‡∏≠‡∏á‡∏®‡∏≤‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠</p>
                <button id="btn-start-game" class="bg-white text-green-900 font-bold py-3 px-8 rounded-full shadow w-full hover:bg-gray-100 transition">
                    <i class="fas fa-play mr-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                </button>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                <h3 class="font-bold text-white mb-4 flex items-center justify-between">
                    <span class="flex items-center gap-2"><i class="fas fa-chart-line text-blue-400"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
                    <button id="btn-export" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded">
                        <i class="fas fa-download mr-1"></i> CSV
                    </button>
                </h3>
                
                <div id="chart-container" class="h-40 flex items-end justify-start gap-3 px-2 border-b border-gray-600 pb-2 overflow-x-auto touch-pan-x">
                    <p class="text-center w-full text-gray-500 text-sm self-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</p>
                </div>

                <!-- Detail Box (Always visible if data exists) -->
                <div id="chart-detail-box" class="mt-4 p-4 bg-gray-700/50 rounded-lg border border-gray-600 shadow-inner">
                    <div id="detail-placeholder" class="text-center text-gray-400 py-2">
                        <i class="fas fa-chart-bar mb-2"></i><br>
                        ‡πÅ‡∏ï‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </div>
                    
                    <div id="detail-content" class="hidden animate-fade-in">
                        <div class="flex justify-between items-center text-sm mb-2 pb-2 border-b border-gray-600">
                            <span class="text-gray-300 font-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                            <span id="detail-date" class="text-white text-xs opacity-75"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <p class="text-xs text-gray-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</p>
                                <p id="detail-score" class="text-xl font-bold text-green-400">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400">‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
                                <p id="detail-grade" class="text-lg font-bold text-yellow-400">-</p>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            <i class="far fa-clock mr-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="detail-time" class="text-white"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <h3 class="font-bold text-white mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <div id="history-list" class="space-y-3 max-h-60 overflow-y-auto pr-1 pb-10">
                </div>
            </div>
        </div>
    </div>

    <!-- 3. GAME SCREEN -->
    <div id="game-screen" class="hidden fixed inset-0 bg-black flex flex-col z-50">
        <!-- Top HUD -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start z-30 pointer-events-none">
            <div class="bg-gray-900/80 backdrop-blur rounded-lg p-2 border border-gray-700 text-center min-w-[80px]">
                <div class="text-[10px] text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div id="game-timer" class="text-3xl font-bold text-white font-mono">120</div>
            </div>
            
            <div class="flex flex-col items-center gap-2 max-w-[50%]">
                <div id="instruction-text" class="text-xl font-bold text-white bg-green-600/90 px-4 py-2 rounded-full shadow-lg border-2 border-white backdrop-blur text-center leading-tight">
                    ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß...
                </div>
                <!-- Status Indicators -->
                <div class="flex flex-col gap-2 items-center w-full">
                    <div id="hold-indicator" class="hidden text-sm font-bold text-black bg-yellow-400 px-4 py-1 rounded-full animate-pulse shadow-lg">
                        <i class="fas fa-hand-paper mr-1"></i> ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ô‡∏¥‡πà‡∏á‡πÜ...
                    </div>
                    <!-- Big Encouragement Text -->
                    <div id="encourage-indicator" class="hidden text-2xl font-bold text-white bg-blue-600/90 border-4 border-yellow-400 px-6 py-3 rounded-2xl shadow-2xl animate-bounce whitespace-nowrap z-50">
                        <i class="fas fa-bullhorn mr-2"></i> ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß!
                    </div>
                </div>
            </div>

            <div class="bg-gray-900/80 backdrop-blur rounded-lg p-2 border border-gray-700 text-center min-w-[80px]">
                <div class="text-[10px] text-gray-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <div id="game-score" class="text-3xl font-bold text-yellow-400">0</div>
            </div>
        </div>

        <!-- Main Video Area -->
        <div id="video-wrapper" class="flex-1 w-full relative">
            <video id="input-video" playsinline></video>
            <canvas id="output-canvas"></canvas>
            <div id="grid-overlay">
                <div class="grid-cell" data-index="0" data-label="1"></div>
                <div class="grid-cell" data-index="1" data-label="2"></div>
                <div class="grid-cell" data-index="2" data-label="3"></div>
                <div class="grid-cell" data-index="3" data-label="4"></div>
                <div class="grid-cell" data-index="4" data-label="5"></div>
                <div class="grid-cell" data-index="5" data-label="6"></div>
                <div class="grid-cell" data-index="6" data-label="7"></div>
                <div class="grid-cell" data-index="7" data-label="8"></div>
                <div class="grid-cell" data-index="8" data-label="9"></div>
            </div>
            
            <div id="feedback-icon" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-all duration-300 scale-50 z-40">
                <i class="fas fa-check-circle text-8xl text-green-400 drop-shadow-[0_0_15px_rgba(74,222,128,0.8)]"></i>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="fixed bottom-0 left-0 w-full flex justify-center gap-4 z-50 p-6 safe-area-bottom bg-gradient-to-t from-black/80 to-transparent">
            <button id="btn-pause-game" class="bg-yellow-500 hover:bg-yellow-400 text-black px-8 py-3 rounded-full font-bold shadow-lg border-2 border-yellow-300 flex items-center gap-2 transition hover:scale-105 pointer-events-auto">
                <i class="fas fa-pause"></i> ‡∏û‡∏±‡∏Å
            </button>
            <button id="btn-stop-game" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-full font-bold shadow-lg border-2 border-red-400 flex items-center gap-2 transition hover:scale-105 pointer-events-auto">
                <i class="fas fa-stop"></i> ‡∏à‡∏ö
            </button>
        </div>
    </div>

    <!-- GLOBAL OVERLAYS -->
    
    <!-- Info Modal -->
    <div id="info-overlay" class="hidden modal-overlay">
        <div class="bg-gray-800 p-6 rounded-2xl border border-gray-600 shadow-2xl max-w-md w-full mx-4 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-info-circle mr-2 text-blue-400"></i>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö NextStepMotion</h2>
                <button id="btn-close-info" class="text-gray-400 hover:text-white p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="overflow-y-auto pr-2 text-gray-300 text-sm space-y-4 custom-scroll">
                <div>
                    <h3 class="text-green-400 font-bold text-base mb-1">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <p>NextStepMotion ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏°‡∏û‡∏≤‡∏ï‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å (Hemiplegia) ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ AI ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ù‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡∏°‡πÅ‡∏Ç‡∏ô (Reaching Task) ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ Wolf Motor Function Test (WMFT)</p>
                </div>
                
                <div>
                    <h3 class="text-yellow-400 font-bold text-base mb-1">üéÆ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                    <ol class="list-decimal pl-4 space-y-2">
                        <li><strong>‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á:</strong> ‡∏ß‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏Ñ‡∏°‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1.5 - 2 ‡πÄ‡∏°‡∏ï‡∏£ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ö‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</li>
                        <li><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏™‡∏µ‡πÅ‡∏î‡∏á)</li>
                        <li><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô:</strong> ‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
                            <ul class="list-disc pl-4 mt-1 text-xs text-gray-400">
                                <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ ‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</li>
                                <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ‡πÉ‡∏´‡πâ <strong>"‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ"</strong> ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</li>
                            </ul>
                        </li>
                        <li><strong>‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å:</strong> ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏à‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</li>
                    </ol>
                </div>

                <div>
                    <h3 class="text-blue-400 font-bold text-base mb-1">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
                    <p>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ü‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á:</p>
                    <ul class="list-disc pl-4 mt-1 text-xs">
                        <li><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠:</strong> ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ</li>
                        <li><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å:</strong> ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1 ‡∏ñ‡∏∂‡∏á 3 ‡∏ô‡∏≤‡∏ó‡∏µ</li>
                        <li><strong>‡πÄ‡∏™‡∏µ‡∏¢‡∏á:</strong> ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏≤‡∏Å‡∏¢‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-700">
                <button id="btn-close-info-bottom" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div id="pause-overlay" class="hidden modal-overlay">
        <div class="text-center p-8 bg-gray-900/90 rounded-2xl border border-gray-700 shadow-2xl max-w-sm w-full mx-4">
            <i class="fas fa-pause-circle text-6xl text-yellow-400 mb-4 animate-bounce"></i>
            <h2 class="text-3xl font-bold text-white mb-2">‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</h2>
            <button id="btn-resume" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-8 rounded-full shadow-lg text-lg mt-6 w-full">
                ‡∏ù‡∏∂‡∏Å‡∏ï‡πà‡∏≠
            </button>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exit-overlay" class="hidden modal-overlay">
        <div class="bg-gray-800 p-6 rounded-2xl border border-gray-600 shadow-2xl max-w-sm w-full mx-4 text-center">
            <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4 animate-pulse"></i>
            <h2 class="text-2xl font-bold text-white mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å?</h2>
            <p class="text-gray-400 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            <div class="flex gap-3">
                <button id="btn-cancel-exit" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-xl font-bold transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button id="btn-confirm-exit" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl font-bold transition">
                    ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-overlay" class="hidden modal-overlay">
        <div class="bg-gray-800 rounded-2xl border border-gray-600 shadow-2xl max-w-sm w-full mx-4 overflow-hidden">
            <div class="bg-green-700 p-4 text-center">
                <h2 class="text-2xl font-bold text-white">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                <p class="text-green-100 text-sm">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π (Adapted WMFT)</p>
            </div>
            <div class="p-6 text-center">
                <div class="inline-block p-4 rounded-full bg-gray-900 border-4 border-yellow-500 mb-4 shadow-lg w-24 h-24 flex items-center justify-center relative">
                    <div>
                        <span id="wmft-score" class="text-4xl font-bold text-white">3</span>
                        <span class="text-xs text-gray-400 block">‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
                    </div>
                </div>
                <h3 id="wmft-label" class="text-xl font-bold text-yellow-400 mb-4">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-700 p-2 rounded-lg">
                        <p class="text-xs text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        <p id="sum-score" class="text-xl font-bold text-white">0</p>
                    </div>
                    <div class="bg-gray-700 p-2 rounded-lg">
                        <p class="text-xs text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ä‡πà‡∏≠‡∏á</p>
                        <p id="sum-avg" class="text-xl font-bold text-blue-400">0s</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button id="btn-discard-summary" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-xl transition">
                        ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                    <button id="btn-save-summary" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="hidden modal-overlay">
        <div class="bg-gray-800 p-6 rounded-2xl border border-gray-600 shadow-2xl max-w-sm w-full mx-4">
            <h2 class="text-xl font-bold text-white mb-4"><i class="fas fa-sliders-h mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ & ‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <!-- Sound Toggle (Fixed) -->
            <div class="mb-4 pb-4 border-b border-gray-700">
                <label class="flex items-center justify-between cursor-pointer w-full select-none">
                    <span class="text-white">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏≤‡∏Å‡∏¢‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</span>
                    <div class="relative">
                        <input type="checkbox" id="setting-sound" class="sr-only toggle-checkbox">
                        <!-- Track -->
                        <div class="w-10 h-6 bg-gray-600 rounded-full shadow-inner toggle-track transition-colors duration-200"></div>
                        <!-- Dot -->
                        <div class="toggle-dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition-transform duration-200"></div>
                    </div>
                </label>
            </div>

            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠ (Hold Duration)</label>
                <!-- Range: 6 frames (~0.2s) to 60 frames (~2s) -->
                <input type="range" id="setting-hold" min="6" max="60" value="30" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>‡πÄ‡∏£‡πá‡∏ß (0.2s)</span>
                    <span id="hold-val" class="text-yellow-400 font-bold">1.0s</span>
                    <span>‡∏ä‡πâ‡∏≤ (2.0s)</span>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-sm mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏° (Game Duration)</label>
                <select id="setting-time" class="w-full bg-gray-700 text-white border border-gray-600 rounded p-2">
                    <option value="60">1 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏™‡∏±‡πâ‡∏ô)</option>
                    <option value="120" selected>2 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
                    <option value="180">3 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏¢‡∏≤‡∏ß)</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button id="btn-cancel-settings" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-save-settings" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & VARIABLES ---
        let GAME_DURATION = 120; 
        let HOLD_DURATION_FRAMES = 30; // Changed default to 30 frames (1s)
        let SOUND_ENABLED = true;
        const SMOOTHING_FACTOR = 0.2; 
        const HIT_TOLERANCE = 0.01; 
        const NEAR_TOLERANCE = 0.25; 

        // State
        let score = 0;
        let timeLeft = GAME_DURATION;
        let isPlaying = false;
        let isPaused = false;
        let currentTargetIndex = -1;
        let timerInterval;
        let pose = null;
        let animationFrameId; 
        let lastSpeakTime = 0;
        let audioContext = null;
        let pendingSessionData = null; 
        let selectedVoice = null;
        
        let framesInTarget = 0;
        let framesInNearZone = 0; 
        let hasEncouraged = false; 
        let isFirstFrame = true;

        let smoothLeftWrist = { x: 0, y: 0, visibility: 0 };
        let smoothRightWrist = { x: 0, y: 0, visibility: 0 };

        // Elements
        const screens = {
            login: document.getElementById('login-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            game: document.getElementById('game-screen')
        };
        const cells = document.querySelectorAll('.grid-cell');
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const gridOverlay = document.getElementById('grid-overlay');
        const settingsOverlay = document.getElementById('settings-overlay');
        const infoOverlay = document.getElementById('info-overlay');

        // --- MATH UTILS ---
        function lerp(start, end, amt) { return (1 - amt) * start + amt * end; }
        
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return Math.round(angle);
        }

        // --- STORAGE ---
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('rehab_settings') || '{}');
                if (settings.gameDuration) GAME_DURATION = parseInt(settings.gameDuration);
                if (settings.holdDuration) HOLD_DURATION_FRAMES = parseInt(settings.holdDuration);
                if (settings.soundEnabled !== undefined) SOUND_ENABLED = settings.soundEnabled;
                
                document.getElementById('setting-time').value = GAME_DURATION;
                document.getElementById('setting-hold').value = HOLD_DURATION_FRAMES;
                document.getElementById('setting-sound').checked = SOUND_ENABLED;
                
                const seconds = (HOLD_DURATION_FRAMES * 0.033).toFixed(1);
                document.getElementById('hold-val').innerText = seconds + "s";
            } catch(e) { console.error(e); }
        }

        function saveSettings() {
            const settings = {
                gameDuration: GAME_DURATION,
                holdDuration: HOLD_DURATION_FRAMES,
                soundEnabled: SOUND_ENABLED
            };
            localStorage.setItem('rehab_settings', JSON.stringify(settings));
        }

        // --- DATA & UI ---
        function showSummary(finalScore) {
            const avgTime = finalScore > 0 ? (GAME_DURATION / finalScore) : 120;
            let wmftGrade = 0;
            let wmftLabel = "";

            if (avgTime < 4.0) { wmftGrade = 5; wmftLabel = "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (Normal)"; }
            else if (avgTime < 8.0) { wmftGrade = 4; wmftLabel = "‡∏î‡∏µ‡∏°‡∏≤‡∏Å (Good)"; }
            else if (avgTime < 15.0) { wmftGrade = 3; wmftLabel = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Fair)"; }
            else if (avgTime < 30.0) { wmftGrade = 2; wmftLabel = "‡∏û‡∏≠‡πÉ‡∏ä‡πâ (Poor)"; }
            else { wmftGrade = 1; wmftLabel = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô (Start)"; }
            
            pendingSessionData = {
                score: finalScore,
                avgTime: avgTime.toFixed(1),
                wmft: wmftGrade,
                label: wmftLabel,
                timestamp: new Date().toISOString()
            };

            document.getElementById('wmft-score').innerText = wmftGrade;
            document.getElementById('wmft-label').innerText = wmftLabel;
            document.getElementById('sum-score').innerText = finalScore;
            document.getElementById('sum-avg').innerText = avgTime.toFixed(1) + "s";
            
            const badge = document.getElementById('wmft-score').parentElement.parentElement;
            badge.className = `inline-block p-4 rounded-full bg-gray-900 border-4 mb-4 shadow-lg w-24 h-24 flex items-center justify-center relative ${
                wmftGrade >= 4 ? 'border-green-500' : (wmftGrade === 3 ? 'border-yellow-500' : 'border-red-500')
            }`;
            document.getElementById('wmft-label').className = `text-xl font-bold mb-4 ${
                wmftGrade >= 4 ? 'text-green-400' : (wmftGrade === 3 ? 'text-yellow-400' : 'text-red-400')
            }`;
            
            document.getElementById('summary-overlay').classList.remove('hidden');
        }

        function loadHistory() {
            const chartContainer = document.getElementById('chart-container');
            const historyList = document.getElementById('history-list');
            try {
                const history = JSON.parse(localStorage.getItem('rehab_history') || '[]');
                
                chartContainer.innerHTML = '';
                if (history.length === 0) {
                    chartContainer.innerHTML = '<p class="text-center w-full text-gray-500 text-sm self-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</p>';
                } else {
                    const recent = history.slice(-10);
                    recent.forEach((data, index) => {
                        const date = new Date(data.timestamp);
                        const day = date.getDate() + '/' + (date.getMonth()+1);
                        const barHeight = (data.wmft / 5) * 100;
                        const barColor = data.wmft >= 4 ? 'bg-green-500' : (data.wmft >= 3 ? 'bg-yellow-500' : 'bg-red-500');
                        
                        const encodedLabel = data.label.replace(/'/g, "\\'"); 
                        
                        const barHtml = `
                            <div onclick="showHistoryDetail('${data.timestamp}', ${data.score}, ${data.wmft}, '${encodedLabel}', '${data.avgTime}', this)" 
                                 class="flex flex-col items-center justify-end h-full min-w-[2rem] group relative cursor-pointer tap-highlight-transparent transition-transform active:scale-95">
                                <div class="w-full ${barColor} rounded-t-md bar-fill hover:opacity-80 transition-opacity" style="height: ${barHeight}%"></div>
                                <span class="text-[10px] text-gray-500 mt-1">${day}</span>
                            </div>
                        `;
                        chartContainer.innerHTML += barHtml;
                    });
                }

                historyList.innerHTML = '';
                const sortedHistory = [...history].reverse().slice(0, 5); 
                sortedHistory.forEach(data => {
                    const date = new Date(data.timestamp).toLocaleString('th-TH');
                    const itemHtml = `
                        <div class="bg-gray-700/50 p-3 rounded-lg flex justify-between items-center border border-gray-600">
                            <div>
                                <p class="text-white font-bold text-sm">‡πÄ‡∏Å‡∏£‡∏î ${data.wmft} - ${data.label}</p>
                                <p class="text-gray-400 text-xs">${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-green-400 font-bold">${data.score} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                                <p class="text-gray-500 text-xs">${data.avgTime} ‡∏ß‡∏¥/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                            </div>
                        </div>
                    `;
                    historyList.innerHTML += itemHtml;
                });
            } catch(e) { console.error("Load Error", e); }
        }

        window.showHistoryDetail = function(timestamp, score, grade, label, avgTime, element) {
            const bars = document.querySelectorAll('#chart-container .bar-fill');
            bars.forEach(b => b.classList.remove('bar-active'));
            
            const innerBar = element.querySelector('.bar-fill');
            if(innerBar) innerBar.classList.add('bar-active');

            const dateObj = new Date(timestamp);
            const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('detail-date').innerText = dateStr;
            document.getElementById('detail-time').innerText = timeStr + " (" + avgTime + " ‡∏ß‡∏¥/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)";
            document.getElementById('detail-score').innerText = score + " ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            document.getElementById('detail-grade').innerText = "‡πÄ‡∏Å‡∏£‡∏î " + grade + " (" + label + ")";

            const detailBox = document.getElementById('chart-detail-box');
            detailBox.classList.remove('hidden');
            
            // Fixed Scroll Logic
            setTimeout(() => {
                const dashboard = document.getElementById('dashboard-screen');
                const detailBoxEl = document.getElementById('chart-detail-box');
                const targetScroll = detailBoxEl.offsetTop - 20;
                
                dashboard.scrollTo({
                    top: targetScroll,
                    behavior: 'smooth'
                });
            }, 50);
        }

        // --- NAVIGATION ---
        function showScreen(name) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[name].classList.remove('hidden');
            if(name === 'dashboard') {
                loadHistory();
                // Check if history exists to auto-select latest
                const history = JSON.parse(localStorage.getItem('rehab_history') || '[]');
                if(history.length > 0) {
                    const latest = history[history.length - 1];
                    document.getElementById('detail-placeholder').classList.add('hidden');
                    document.getElementById('detail-content').classList.remove('hidden');
                    
                    const dateObj = new Date(latest.timestamp);
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
                    const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('detail-date').innerText = dateStr;
                    document.getElementById('detail-time').innerText = timeStr + " (" + latest.avgTime + " ‡∏ß‡∏¥/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)";
                    document.getElementById('detail-score').innerText = latest.score + " ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                    document.getElementById('detail-grade').innerText = "‡πÄ‡∏Å‡∏£‡∏î " + latest.wmft + " (" + latest.label + ")";
                } else {
                    // Reset to placeholder
                    document.getElementById('detail-placeholder').classList.remove('hidden');
                    document.getElementById('detail-content').classList.add('hidden');
                }
            }
        }

        // --- AUDIO ---
        function initVoices() {
            // Force load voices
            voices = window.speechSynthesis.getVoices();
        }

        function speak(text) {
            if(!SOUND_ENABLED) return;
            const now = Date.now();
            if (now - lastSpeakTime < 2000) return; // Reduce to 2s
            lastSpeakTime = now;
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH';
                // Try to find a thai voice
                const voices = window.speechSynthesis.getVoices();
                const thaiVoice = voices.find(v => v.lang === 'th-TH');
                if(thaiVoice) utterance.voice = thaiVoice;
                
                // Tweak voice
                utterance.rate = 0.9;
                utterance.pitch = 1.1;

                window.speechSynthesis.speak(utterance);
            }
        }

        function playSuccessSound() {
            if(!SOUND_ENABLED) return;
            if (!audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(AudioContext) audioContext = new AudioContext();
            }
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                osc.start();
                osc.stop(audioContext.currentTime + 0.3);
            }
        }

        // --- CORE LOGIC : RESIZING & COORDINATES ---
        function resizeCanvas() {
            const videoRatio = videoElement.videoWidth / videoElement.videoHeight;
            if (!videoRatio) return;

            const screenRatio = window.innerWidth / window.innerHeight;
            let drawWidth, drawHeight;

            if (screenRatio > videoRatio) {
                drawHeight = window.innerHeight;
                drawWidth = drawHeight * videoRatio;
            } else {
                drawWidth = window.innerWidth;
                drawHeight = drawWidth / videoRatio;
            }

            gridOverlay.style.width = `${drawWidth}px`;
            gridOverlay.style.height = `${drawHeight}px`;
            
            if(drawWidth > 0 && drawHeight > 0) {
                gridOverlay.classList.add('visible');
            }

            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
        }

        // --- MEDIAPIPE ---
        function onResults(results) {
            if (isFirstFrame && results.image.width > 0) {
                resizeCanvas();
                isFirstFrame = false;
            }

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.translate(canvasElement.width, 0);
            canvasCtx.scale(-1, 1);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2, radius: 3});
                
                const leftShoulder = results.poseLandmarks[11];
                const leftElbow = results.poseLandmarks[13];
                const leftWrist = results.poseLandmarks[15];
                const rightShoulder = results.poseLandmarks[12];
                const rightElbow = results.poseLandmarks[14];
                const rightWrist = results.poseLandmarks[16];

                const VISIBILITY_THRESHOLD = 0.40; 

                if (leftWrist.visibility > VISIBILITY_THRESHOLD) {
                    smoothLeftWrist.x = lerp(smoothLeftWrist.x, leftWrist.x, SMOOTHING_FACTOR);
                    smoothLeftWrist.y = lerp(smoothLeftWrist.y, leftWrist.y, SMOOTHING_FACTOR);
                    smoothLeftWrist.visibility = leftWrist.visibility;
                } else {
                    smoothLeftWrist.visibility = lerp(smoothLeftWrist.visibility, 0, 0.05);
                }

                if (rightWrist.visibility > VISIBILITY_THRESHOLD) {
                    smoothRightWrist.x = lerp(smoothRightWrist.x, rightWrist.x, SMOOTHING_FACTOR);
                    smoothRightWrist.y = lerp(smoothRightWrist.y, rightWrist.y, SMOOTHING_FACTOR);
                    smoothRightWrist.visibility = rightWrist.visibility;
                } else {
                    smoothRightWrist.visibility = lerp(smoothRightWrist.visibility, 0, 0.05);
                }

                canvasCtx.fillStyle = 'rgba(255, 0, 255, 0.4)';
                canvasCtx.strokeStyle = 'white';
                canvasCtx.lineWidth = 4;
                // Font setup is done inside the drawing logic now for flipping
                
                let activeWristInTarget = false;
                let activeWristNearTarget = false;

                if (smoothLeftWrist.visibility > 0.4) {
                    const x = smoothLeftWrist.x * canvasElement.width;
                    const y = smoothLeftWrist.y * canvasElement.height;
                    
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 50, 0, 2 * Math.PI);
                    canvasCtx.fill();
                    canvasCtx.stroke();
                    
                    // Angle
                    if (leftElbow.visibility > 0.5 && leftShoulder.visibility > 0.5) {
                        const angle = calculateAngle(leftShoulder, leftElbow, leftWrist);
                        
                        canvasCtx.save();
                        // Move to elbow position
                        canvasCtx.translate(leftElbow.x * canvasElement.width, leftElbow.y * canvasElement.height);
                        // Flip text back
                        canvasCtx.scale(-1, 1);
                        
                        canvasCtx.font = "bold 36px Prompt, Arial";
                        canvasCtx.fillStyle = "#fbbf24"; // Yellow
                        canvasCtx.strokeStyle = "black";
                        canvasCtx.lineWidth = 4;
                        canvasCtx.strokeText(angle + "¬∞", 15, 0); 
                        canvasCtx.fillText(angle + "¬∞", 15, 0);
                        
                        canvasCtx.restore();
                        canvasCtx.fillStyle = 'rgba(255, 0, 255, 0.4)'; // Reset
                    }

                    if (isPlaying && !isPaused && currentTargetIndex !== -1) {
                        if(checkHover(smoothLeftWrist, false)) activeWristInTarget = true;
                        else if(checkHover(smoothLeftWrist, true)) activeWristNearTarget = true;
                    }
                }

                if (smoothRightWrist.visibility > 0.4) {
                    const x = smoothRightWrist.x * canvasElement.width;
                    const y = smoothRightWrist.y * canvasElement.height;
                    
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 50, 0, 2 * Math.PI);
                    canvasCtx.fill();
                    canvasCtx.stroke();

                    // Angle
                    if (rightElbow.visibility > 0.5 && rightShoulder.visibility > 0.5) {
                        const angle = calculateAngle(rightShoulder, rightElbow, rightWrist);
                        
                        canvasCtx.save();
                        // Move to elbow position
                        canvasCtx.translate(rightElbow.x * canvasElement.width, rightElbow.y * canvasElement.height);
                        // Flip text back
                        canvasCtx.scale(-1, 1);
                        
                        canvasCtx.font = "bold 36px Prompt, Arial";
                        canvasCtx.fillStyle = "cyan";
                        canvasCtx.strokeStyle = "black";
                        canvasCtx.lineWidth = 4;
                        // For right arm, we might want to draw it to the left side (which is right side in flipped context... confusing, let's just use offset)
                        canvasCtx.strokeText(angle + "¬∞", -80, 0); 
                        canvasCtx.fillText(angle + "¬∞", -80, 0);
                        
                        canvasCtx.restore();
                        canvasCtx.fillStyle = 'rgba(255, 0, 255, 0.4)';
                    }

                    if (isPlaying && !isPaused && currentTargetIndex !== -1) {
                        if(checkHover(smoothRightWrist, false)) activeWristInTarget = true;
                        else if(checkHover(smoothRightWrist, true)) activeWristNearTarget = true;
                    }
                }
                updateGameLogic(activeWristInTarget, activeWristNearTarget);
            }
            canvasCtx.restore();
        }

        // --- TOLERANCE LOGIC ---
        function checkHover(wrist, isNearCheck) {
            const targetRow = Math.floor(currentTargetIndex / 3);
            const targetCol = currentTargetIndex % 3;
            
            const TOLERANCE = isNearCheck ? NEAR_TOLERANCE : HIT_TOLERANCE;
            
            let minX, maxX;
            if (targetCol === 0) { minX = 0.66 - TOLERANCE; maxX = 1.0; }       
            else if (targetCol === 1) { minX = 0.33 - TOLERANCE; maxX = 0.66 + TOLERANCE; } 
            else { minX = 0.0; maxX = 0.33 + TOLERANCE; }                       
            
            const minY = (targetRow * 0.33) - TOLERANCE;
            const maxY = ((targetRow + 1) * 0.33) + TOLERANCE;
            return (wrist.x >= minX && wrist.x <= maxX && wrist.y >= minY && wrist.y <= maxY);
        }

        function updateGameLogic(isInTarget, isNearTarget) {
            if (currentTargetIndex === -1 || !cells[currentTargetIndex]) return;
            const targetCell = cells[currentTargetIndex];
            
            if (isInTarget) {
                framesInTarget++;
                framesInNearZone = 0; 
                
                targetCell.classList.add('hovering');
                targetCell.classList.remove('near'); 
                document.getElementById('hold-indicator').classList.remove('hidden');
                document.getElementById('encourage-indicator').classList.add('hidden');
                
                if (framesInTarget >= HOLD_DURATION_FRAMES) handleSuccess();
            } else {
                framesInTarget = Math.max(0, framesInTarget - 1); 
                
                if (isNearTarget) {
                    // Update state
                    targetCell.classList.add('near');
                    framesInNearZone++;
                    
                    // Logic: Trigger encouragement
                    // 30 frames ~ 1 second
                    if(framesInNearZone > 30 && !hasEncouraged) {
                        speak("‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤");
                        hasEncouraged = true;
                        document.getElementById('encourage-indicator').classList.remove('hidden');
                        setTimeout(() => document.getElementById('encourage-indicator').classList.add('hidden'), 2500);
                    }
                } else {
                    // LEFT THE ZONE - RESET ENCOURAGEMENT
                    framesInNearZone = 0;
                    hasEncouraged = false; // Allows it to trigger again next time
                    targetCell.classList.remove('near');
                }

                if (framesInTarget === 0) {
                    targetCell.classList.remove('hovering');
                    document.getElementById('hold-indicator').classList.add('hidden');
                }
            }
        }

        function handleSuccess() {
            framesInTarget = 0;
            framesInNearZone = 0;
            const oldIndex = currentTargetIndex;
            score++;
            document.getElementById('game-score').innerText = score;
            
            const cell = cells[oldIndex];
            cell.classList.remove('target', 'hovering', 'near');
            cell.classList.add('success');
            document.getElementById('hold-indicator').classList.add('hidden');
            document.getElementById('encourage-indicator').classList.add('hidden');
            
            const icon = document.getElementById('feedback-icon');
            icon.classList.remove('opacity-0', 'scale-50');
            icon.classList.add('opacity-100', 'scale-100');
            
            setTimeout(() => {
                icon.classList.add('opacity-0', 'scale-50');
                icon.classList.remove('opacity-100', 'scale-100');
            }, 500);

            playSuccessSound();
            speak(["‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å", "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°", "‡∏î‡∏µ‡∏°‡∏≤‡∏Å", "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"][Math.floor(Math.random()*4)]);

            currentTargetIndex = -1; 
            setTimeout(() => {
                cell.classList.remove('success');
                pickNewTarget();
            }, 600);
        }

        function pickNewTarget() {
            if (!isPlaying || isPaused) return;
            cells.forEach(c => c.classList.remove('target', 'hovering', 'success', 'near'));
            let newIndex;
            do { newIndex = Math.floor(Math.random() * 9); } while (newIndex === currentTargetIndex && score > 0);
            currentTargetIndex = newIndex;
            cells[currentTargetIndex].classList.add('target');
            
            framesInNearZone = 0;
            hasEncouraged = false;
            
            const targetNum = currentTargetIndex + 1;
            document.getElementById('instruction-text').innerText = `‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á ${targetNum}`;
        }

        function startTimer() {
            timeLeft = GAME_DURATION;
            document.getElementById('game-timer').innerText = timeLeft;
            document.getElementById('game-timer').classList.remove('text-red-500');
            
            timerInterval = setInterval(() => {
                if (!isPlaying || isPaused) return;
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft;
                if(timeLeft <= 10) document.getElementById('game-timer').classList.add('text-red-500');
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        // --- EXPORT & SETTINGS ---
        function exportHistory() {
            const history = JSON.parse(localStorage.getItem('rehab_history') || '[]');
            if (history.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }
            let csvContent = "data:text/csv;charset=utf-8,Date,Score,AvgTime,Grade\n";
            history.forEach(row => {
                csvContent += `${row.timestamp},${row.score},${row.avgTime},${row.wmft}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "rehab_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('btn-export').addEventListener('click', exportHistory);
        document.getElementById('btn-settings').addEventListener('click', () => {
            // Load current settings into modal before showing
            document.getElementById('setting-time').value = GAME_DURATION;
            document.getElementById('setting-hold').value = HOLD_DURATION_FRAMES;
            document.getElementById('setting-sound').checked = SOUND_ENABLED;
            const seconds = (HOLD_DURATION_FRAMES * 0.033).toFixed(1);
            document.getElementById('hold-val').innerText = seconds + "s";
            
            settingsOverlay.classList.remove('hidden');
        });
        document.getElementById('btn-cancel-settings').addEventListener('click', () => {
            settingsOverlay.classList.add('hidden');
        });
        document.getElementById('setting-hold').addEventListener('input', (e) => {
            const val = e.target.value;
            const seconds = (val * 0.033).toFixed(1);
            document.getElementById('hold-val').innerText = seconds + "s";
        });
        document.getElementById('btn-save-settings').addEventListener('click', () => {
            HOLD_DURATION_FRAMES = parseInt(document.getElementById('setting-hold').value);
            GAME_DURATION = parseInt(document.getElementById('setting-time').value);
            SOUND_ENABLED = document.getElementById('setting-sound').checked;
            
            saveSettings(); // Persist
            settingsOverlay.classList.add('hidden');
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
        });

        // --- INFO MODAL HANDLERS ---
        document.getElementById('btn-info').addEventListener('click', () => {
            infoOverlay.classList.remove('hidden');
        });

        document.getElementById('btn-close-info').addEventListener('click', () => {
            infoOverlay.classList.add('hidden');
        });

        document.getElementById('btn-close-info-bottom').addEventListener('click', () => {
            infoOverlay.classList.add('hidden');
        });

        // --- GAME CONTROL ---
        function pauseGame() {
            if(!isPlaying) return;
            isPaused = true;
            document.getElementById('pause-overlay').classList.remove('hidden');
            document.getElementById('hold-indicator').classList.add('hidden');
            cells.forEach(c => c.classList.remove('hovering'));
        }

        function resumeGame() {
            if(!isPlaying) return;
            isPaused = false;
            document.getElementById('pause-overlay').classList.add('hidden');
            if(currentTargetIndex === -1) pickNewTarget();
        }

        function endGame() {
            isPlaying = false;
            isPaused = false;
            clearInterval(timerInterval);
            speak("‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å");
            showSummary(score);
        }

        // --- MANUAL CAMERA & AI LOOP ---
        async function startCameraAndAI() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 } 
                });
                videoElement.srcObject = stream;
                
                await new Promise(r => videoElement.onloadedmetadata = r);
                videoElement.play();
                
                pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1635988162/${file}`});
                pose.setOptions({
                    modelComplexity: 1, 
                    smoothLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                pose.onResults(onResults);

                processFrame();

            } catch (e) {
                console.error(e);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + e.message);
                showScreen('dashboard');
            }
        }

        async function processFrame() {
            if (!isPlaying || isPaused) {
                if(isPlaying) animationFrameId = requestAnimationFrame(processFrame);
                return;
            }
            
            await pose.send({image: videoElement});
            animationFrameId = requestAnimationFrame(processFrame);
        }

        function stopCamera() {
            cancelAnimationFrame(animationFrameId);
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(t => t.stop());
                videoElement.srcObject = null;
            }
        }

        // --- HANDLERS ---
        document.getElementById('btn-demo-start').addEventListener('click', () => {
            showScreen('dashboard');
            // Init voices early
            initVoices();
        });
        document.getElementById('btn-logout').addEventListener('click', () => showScreen('login'));

        document.getElementById('btn-start-game').addEventListener('click', async () => {
            // Unlock audio context on start
            if(SOUND_ENABLED) {
                speechSynthesis.speak(new SpeechSynthesisUtterance(''));
            }

            showScreen('game');
            score = 0;
            framesInTarget = 0;
            timeLeft = GAME_DURATION; 
            document.getElementById('game-score').innerText = "0";
            
            isFirstFrame = true; 
            isPaused = false;
            gridOverlay.classList.remove('visible');
            document.getElementById('pause-overlay').classList.add('hidden');
            document.getElementById('summary-overlay').classList.add('hidden');
            document.getElementById('exit-overlay').classList.add('hidden');
            
            smoothLeftWrist = { x: 0, y: 0, visibility: 0 };
            smoothRightWrist = { x: 0, y: 0, visibility: 0 };
            
            isPlaying = true;
            await startCameraAndAI();
            pickNewTarget();
            startTimer();
        });

        document.getElementById('btn-pause-game').addEventListener('click', pauseGame);
        document.getElementById('btn-resume').addEventListener('click', resumeGame);
        
        document.getElementById('btn-stop-game').addEventListener('click', () => {
            if (!isPlaying && !isPaused) return;
            isPaused = true; 
            document.getElementById('exit-overlay').classList.remove('hidden');
        });

        document.getElementById('btn-cancel-exit').addEventListener('click', () => {
            document.getElementById('exit-overlay').classList.add('hidden');
            if(document.getElementById('pause-overlay').classList.contains('hidden')) isPaused = false;
        });

        document.getElementById('btn-confirm-exit').addEventListener('click', () => {
            document.getElementById('exit-overlay').classList.add('hidden');
            endGame();
        });

        document.getElementById('btn-save-summary').addEventListener('click', () => {
            if(pendingSessionData) {
                try {
                    const history = JSON.parse(localStorage.getItem('rehab_history') || '[]');
                    history.push(pendingSessionData);
                    localStorage.setItem('rehab_history', JSON.stringify(history));
                } catch(e) { console.error("Save failed", e); }
            }
            document.getElementById('summary-overlay').classList.add('hidden');
            stopCamera();
            showScreen('dashboard');
        });

        document.getElementById('btn-discard-summary').addEventListener('click', () => {
            pendingSessionData = null; 
            document.getElementById('summary-overlay').classList.add('hidden');
            stopCamera();
            showScreen('dashboard');
        });
        
        window.addEventListener('resize', () => { if(isPlaying) resizeCanvas(); });
        
        // Init Voices on Load
        window.speechSynthesis.onvoiceschanged = initVoices;

        if(localStorage.getItem('rehab_history')) loadHistory();
        loadSettings(); 

    </script>
</body>
</html>